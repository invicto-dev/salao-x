generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================
// Enums
// ============================

enum Role {
  ROOT
  ADMIN
  GERENTE
  SECRETARIO
  FUNCIONARIO
}

enum StockMovementType {
  ENTRADA
  SAIDA
  AJUSTE
}

enum StockMovementReason {
  COMPRA
  VENDA
  QUEBRA
  VENCIMENTO
  DEVOLUCAO
  AJUSTE_INVENTARIO
  INSUMO_PARA_USO
  CANCELAMENTO_VENDA
}

enum ApprovalStatus {
  PENDENTE
  APROVADO
  REJEITADO
}

enum JobStatus {
  PENDENTE
  PROCESSANDO
  CONCLUIDO
  CONCLUIDO_COM_ERROS
  FALHOU
}

enum FiscalNoteStatus {
  PENDENTE
  PROCESSANDO
  AUTORIZADA
  ERRO
  CANCELADA
}

enum FiscalNoteType {
  NFE
  NFCE
}

enum SaleStatus {
  PENDENTE
  PAGO
  CANCELADO
}

enum CaixaStatus {
  ABERTO
  FECHADO
}

enum CaixaMovimentacaoTipo {
  ENTRADA // Cash supply (suprimento)
  SAIDA // Cash withdrawal (sangria)
}

enum DescontoOuAcrescimoTipo {
  PORCENTAGEM
  VALOR
}

// ============================
// Core Models
// ============================

/// System-wide settings and configuration
model Setting {
  id String @id @default(uuid())

  // Company information
  nomeEmpresa          String
  cnpj                 String? @unique
  endereco             String?
  numero               String?
  complemento          String?
  uf                   String?
  codigoIbge           String?
  bairro               String?
  cidade               String?
  cep                  String?
  telefone             String?
  email                String? @unique
  site                 String?
  horarioFuncionamento Json? // Business hours: Record<Day, Hour>
  intervaloPadrao      Int?
  antecedenciaMinima   Int?

  inscricaoEstadual  String?
  inscricaoMunicipal String?
  regimeTributario   String?

  certificadoA1    Bytes?
  senhaCertificado String?

  // Notifications
  notificarAgendamentos Boolean? @default(false)
  notificarEstoqueBaixo Boolean? @default(false)
  notificarAniversarios Boolean? @default(false)
  whatsappAtivo         Boolean? @default(false)
  emailAtivo            Boolean? @default(false)

  // System settings
  timezone               String?
  exigirAprovacaoEstoque Boolean? @default(false)
  currency               String?  @default("BRL")
  asaasActive            Boolean  @default(false)
  asaasApiKey            String?
  asaasEnvironment       String?  @default("production")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ImportJob {
  id               String    @id @default(uuid())
  status           JobStatus @default(PENDENTE)
  totalRows        Int       @default(0)
  processedRows    Int       @default(0)
  successfulRows   Int       @default(0)
  failedRows       Int       @default(0)
  results          Json? // Armazena detalhes de erros por linha
  originalFilename String
  storedFilename   String    @unique // Nome do arquivo salvo no servidor

  createdByUserId String?   @map("created_by_user_id")
  createdBy       Employee? @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt   DateTime  @default(now())
  completedAt DateTime?
}

/// Employee with role-based access and related records
model Employee {
  id       String  @id @default(uuid())
  nome     String
  email    String  @unique
  telefone String
  funcao   String
  comissao Decimal
  ativo    Boolean
  senha    String
  role     Role

  vendas                   Sale[]
  movimentacoesSolicitadas StockMovement[] @relation("SolicitadoPor")
  movimentacoesAprovadas   StockMovement[] @relation("AprovadoPor")

  caixasAbertos      Caixa[]             @relation("CaixaAbertoPor")
  caixasFechados     Caixa[]             @relation("CaixaFechadoPor")
  caixaMovimentacoes CaixaMovimentacao[]
  mportJobs          ImportJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Customer information and credit settings
model Customer {
  id          String    @id @default(uuid())
  nome        String
  telefone    String?
  email       String?   @unique
  cpfCnpj     String?   @unique
  aniversario DateTime?
  observacoes String?
  ativo       Boolean   @default(true)

  fine            Decimal? @default(0) // Fine percentage
  interest        Decimal? @default(0) // Interest percentage
  creditLimit     Decimal? @default(0) // Credit limit
  paymentDueDay   Int? // Preferred due day (e.g. 5, 10, 15, 20, 25)
  asaasCustomerId String?  @unique // Asaas customer ID

  vendas Sale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Services offered by the company
model Service {
  id            String   @id @default(uuid())
  nome          String
  codigo        String?  @unique
  valorEmAberto Boolean  @default(false)
  preco         Decimal?
  duracao       Int?
  ativo         Boolean  @default(true)
  descricao     String?

  categoriaId String?
  categoria   Category? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  itensVenda SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Products stored in inventory
model Product {
  id            String   @id @default(uuid())
  nome          String
  codigo        String?  @unique
  preco         Decimal?
  custo         Decimal?
  valorEmAberto Boolean  @default(false)
  contarEstoque Boolean  @default(true)
  estoqueMinimo Int?     @default(1)
  unidadeMedida String   @default("un")
  estoqueAtual  Decimal  @default(0)
  ativo         Boolean  @default(true)
  descricao     String?

  ncm    String?
  cfop   String?
  origem Int?

  icmsCst      String?
  icmsAliquota Decimal?

  pisCst      String?
  pisAliquota Decimal?

  cofinsCst      String?
  cofinsAliquota Decimal?

  unidadeTributavel    String?  @default("un")
  quantidadeTributavel Decimal? @default(1)

  categoriaId String?
  categoria   Category? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  itensVenda    SaleItem[]
  movimentacoes StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nome])
  @@index([codigo])
  @@index([categoriaId])
  @@index([ativo])
}

/// Stock movement for products (inbound/outbound/adjustments)
model StockMovement {
  id String @id @default(uuid())

  produtoId String
  produto   Product @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  tipo       StockMovementType
  motivo     StockMovementReason
  quantidade Decimal

  saleId String? // Optional: not all movements are linked to a sale
  sale   Sale?   @relation(fields: [saleId], references: [id], onDelete: SetNull)

  custoUnitario Decimal?
  observacao    String?
  status        ApprovalStatus @default(PENDENTE)

  solicitadoPorId String
  solicitadoPor   Employee @relation("SolicitadoPor", fields: [solicitadoPorId], references: [id])

  aprovadoPorId String?
  aprovadoPor   Employee? @relation("AprovadoPor", fields: [aprovadoPorId], references: [id])

  dataAprovacao  DateTime?
  motivoRejeicao String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([produtoId, status])
}

/// Payment methods supported by the system
model PaymentMethod {
  id        String  @id @default(uuid())
  nome      String  @unique
  descricao String?
  ativo     Boolean @default(true)
  chavePix  String?
  isCash    Boolean @default(false)

  integration String? @unique // Example: 'Asaas'

  pagamentos SalePayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Product/service categories
model Category {
  id        String  @id @default(uuid())
  nome      String  @unique
  descricao String?
  ativo     Boolean @default(true)

  products Product[]
  services Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================
// Sales & Payments
// ============================

model FiscalNote {
  id String @id @default(uuid())

  saleId String @unique
  sale   Sale   @relation(fields: [saleId], references: [id])

  status FiscalNoteStatus @default(PENDENTE)
  tipo   FiscalNoteType

  providerId  String? @unique
  chaveAcesso String? @unique
  numero      String?
  serie       String?
  xmlUrl      String?
  danfeUrl    String?

  mensagemErro String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Sale record (order)
model Sale {
  id            String    @id @default(uuid())
  clienteId     String?
  cliente       Customer? @relation(fields: [clienteId], references: [id])
  funcionarioId String?
  funcionario   Employee? @relation(fields: [funcionarioId], references: [id])

  subtotal Decimal
  total    Decimal
  troco    Decimal?
  status   SaleStatus @default(PENDENTE)

  itens         SaleItem[]
  pagamentos    SalePayment[]
  movimentacoes StockMovement[]
  fiscalNote    FiscalNote?
  caixaId       String?
  caixa         Caixa?          @relation(fields: [caixaId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Items belonging to a sale (products or services)
model SaleItem {
  id      String @id @default(uuid())
  vendaId String
  venda   Sale   @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  produtoId String?
  produto   Product? @relation(fields: [produtoId], references: [id], onDelete: SetNull)
  servicoId String?
  servico   Service? @relation(fields: [servicoId], references: [id], onDelete: SetNull)

  nome String

  desconto      Decimal?
  descontoTipo  DescontoOuAcrescimoTipo? @default(PORCENTAGEM)
  acrescimo     Decimal?
  acrescimoTipo DescontoOuAcrescimoTipo? @default(PORCENTAGEM)

  quantidade Int     @default(1)
  preco      Decimal
  subtotal   Decimal // (preco * quantidade) - desconto + acr√©scimo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Payments associated with a sale
model SalePayment {
  id      String @id @default(uuid())
  vendaId String
  venda   Sale   @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  metodoDePagamentoId String
  metodoDePagamento   PaymentMethod @relation(fields: [metodoDePagamentoId], references: [id])

  valor      Decimal
  observacao String?

  externalChargeId  String? @unique // External Asaas charge ID
  externalChargeUrl String? // Asaas invoice link
  installmentCount  Int? // Number of installments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================
// Cash Register (Caixa)
// ============================

/// Cash register session
model Caixa {
  id String @id @default(uuid())

  dataAbertura             DateTime    @default(now())
  dataFechamento           DateTime?
  valorAbertura            Decimal
  valorFechamentoInformado Decimal?
  valorFechamentoCalculado Decimal?
  diferenca                Decimal?
  status                   CaixaStatus @default(ABERTO)
  observacoes              String?

  funcionarioAberturaId   String
  funcionarioAbertura     Employee  @relation("CaixaAbertoPor", fields: [funcionarioAberturaId], references: [id])
  funcionarioFechamentoId String?
  funcionarioFechamento   Employee? @relation("CaixaFechadoPor", fields: [funcionarioFechamentoId], references: [id])

  vendas        Sale[]
  movimentacoes CaixaMovimentacao[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Cash register transactions (in/out)
model CaixaMovimentacao {
  id     String                @id @default(uuid())
  valor  Decimal
  tipo   CaixaMovimentacaoTipo
  motivo String // Example: "Supplier payment", "Cash reinforcement"

  caixaId       String
  caixa         Caixa    @relation(fields: [caixaId], references: [id], onDelete: Cascade)
  funcionarioId String
  funcionario   Employee @relation(fields: [funcionarioId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
