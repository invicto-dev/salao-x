generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================
// Enums
// ============================

enum Role {
  ROOT
  ADMIN
  GERENTE
  SECRETARIO
  FUNCIONARIO
}

enum StockMovementType {
  ENTRADA
  SAIDA
  AJUSTE
}

enum StockMovementReason {
  COMPRA
  VENDA
  QUEBRA
  VENCIMENTO
  DEVOLUCAO
  AJUSTE_INVENTARIO
  INSUMO_PARA_USO
  CANCELAMENTO_VENDA
}

enum ApprovalStatus {
  PENDENTE
  APROVADO
  REJEITADO
}

enum SaleStatus {
  PENDENTE
  PAGO
  CANCELADO
}

enum CaixaStatus {
  ABERTO
  FECHADO
}

enum CaixaMovimentacaoTipo {
  ENTRADA // Cash supply (suprimento)
  SAIDA // Cash withdrawal (sangria)
}

// ============================
// Core Models
// ============================

/// System-wide settings and configuration
model Setting {
  id String @id @default(uuid())

  // Company information
  nomeEmpresa String
  cnpj        String? @unique
  endereco    String?
  bairro      String?
  cidade      String?
  cep         String?
  telefone    String?
  email       String? @unique
  site        String?

  horarioFuncionamento Json? // Business hours: Record<Day, Hour>
  intervaloPadrao      Int?
  antecedenciaMinima   Int?

  // Notifications
  notificarAgendamentos Boolean? @default(false)
  notificarEstoqueBaixo Boolean? @default(false)
  notificarAniversarios Boolean? @default(false)
  whatsappAtivo         Boolean? @default(false)
  emailAtivo            Boolean? @default(false)

  // System settings
  timezone               String?
  exigirAprovacaoEstoque Boolean? @default(false)
  currency               String?  @default("BRL")
  asaasActive            Boolean  @default(false)
  asaasApiKey            String?
  asaasEnvironment       String?  @default("production")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Employee with role-based access and related records
model Employee {
  id       String  @id @default(uuid())
  nome     String
  email    String  @unique
  telefone String
  funcao   String
  comissao Decimal
  ativo    Boolean
  senha    String
  role     Role

  vendas                   Sale[]
  movimentacoesSolicitadas StockMovement[] @relation("SolicitadoPor")
  movimentacoesAprovadas   StockMovement[] @relation("AprovadoPor")

  caixasAbertos      Caixa[]             @relation("CaixaAbertoPor")
  caixasFechados     Caixa[]             @relation("CaixaFechadoPor")
  caixaMovimentacoes CaixaMovimentacao[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Customer information and credit settings
model Customer {
  id          String    @id @default(uuid())
  nome        String
  telefone    String?
  email       String?   @unique
  cpf         String?   @unique
  aniversario DateTime?
  observacoes String?
  ativo       Boolean   @default(true)

  fine            Decimal? @default(0) // Fine percentage
  interest        Decimal? @default(0) // Interest percentage
  creditLimit     Decimal? @default(0) // Credit limit
  paymentDueDay   Int? // Preferred due day (e.g. 5, 10, 15, 20, 25)
  asaasCustomerId String?  @unique // Asaas customer ID

  vendas Sale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Services offered by the company
model Service {
  id            String   @id @default(uuid())
  nome          String
  codigo        String?  @unique
  valorEmAberto Boolean  @default(false)
  preco         Decimal?
  duracao       Int?
  ativo         Boolean  @default(true)
  descricao     String?

  categoriaId String?
  categoria   Category? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  itensVenda SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Products stored in inventory
model Product {
  id            String   @id @default(uuid())
  nome          String
  codigo        String?  @unique
  preco         Decimal?
  custo         Decimal?
  valorEmAberto Boolean  @default(false)
  contarEstoque Boolean  @default(true)
  estoqueMinimo Int?     @default(1)
  unidadeMedida String   @default("un")
  ativo         Boolean  @default(true)
  descricao     String?

  categoriaId String?
  categoria   Category? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  itensVenda    SaleItem[]
  movimentacoes StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Stock movement for products (inbound/outbound/adjustments)
model StockMovement {
  id String @id @default(uuid())

  produtoId String
  produto   Product @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  tipo       StockMovementType
  motivo     StockMovementReason
  quantidade Decimal

  saleId String? // Optional: not all movements are linked to a sale
  sale   Sale?   @relation(fields: [saleId], references: [id], onDelete: SetNull)

  custoUnitario Decimal?
  observacao    String?
  status        ApprovalStatus @default(PENDENTE)

  solicitadoPorId String
  solicitadoPor   Employee @relation("SolicitadoPor", fields: [solicitadoPorId], references: [id])

  aprovadoPorId String?
  aprovadoPor   Employee? @relation("AprovadoPor", fields: [aprovadoPorId], references: [id])

  dataAprovacao  DateTime?
  motivoRejeicao String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Payment methods supported by the system
model PaymentMethod {
  id        String  @id @default(uuid())
  nome      String  @unique
  descricao String?
  ativo     Boolean @default(true)
  chavePix  String?
  isCash    Boolean @default(false)

  integration String? @unique // Example: 'Asaas'

  pagamentos SalePayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Product/service categories
model Category {
  id        String  @id @default(uuid())
  nome      String  @unique
  descricao String?
  ativo     Boolean @default(true)

  products Product[]
  services Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================
// Sales & Payments
// ============================

/// Sale record (order)
model Sale {
  id            String    @id @default(uuid())
  clienteId     String?
  cliente       Customer? @relation(fields: [clienteId], references: [id])
  funcionarioId String?
  funcionario   Employee? @relation(fields: [funcionarioId], references: [id])

  subtotal  Decimal
  total     Decimal
  troco     Decimal?
  desconto  Decimal?
  acrescimo Decimal?
  status    SaleStatus @default(PENDENTE)

  itens         SaleItem[]
  pagamentos    SalePayment[]
  movimentacoes StockMovement[]

  caixaId String?
  caixa   Caixa?  @relation(fields: [caixaId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Items belonging to a sale (products or services)
model SaleItem {
  id      String @id @default(uuid())
  vendaId String
  venda   Sale   @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  produtoId String?
  produto   Product? @relation(fields: [produtoId], references: [id], onDelete: SetNull)

  servicoId String?
  servico   Service? @relation(fields: [servicoId], references: [id], onDelete: SetNull)

  quantidade Int     @default(1)
  preco      Decimal
  subtotal   Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Payments associated with a sale
model SalePayment {
  id      String @id @default(uuid())
  vendaId String
  venda   Sale   @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  metodoDePagamentoId String
  metodoDePagamento   PaymentMethod @relation(fields: [metodoDePagamentoId], references: [id])

  valor      Decimal
  observacao String?

  externalChargeId  String? @unique // External Asaas charge ID
  externalChargeUrl String? // Asaas invoice link
  installmentCount  Int? // Number of installments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================
// Cash Register (Caixa)
// ============================

/// Cash register session
model Caixa {
  id String @id @default(uuid())

  dataAbertura             DateTime    @default(now())
  dataFechamento           DateTime?
  valorAbertura            Decimal
  valorFechamentoInformado Decimal?
  valorFechamentoCalculado Decimal?
  diferenca                Decimal?
  status                   CaixaStatus @default(ABERTO)
  observacoes              String?

  funcionarioAberturaId   String
  funcionarioAbertura     Employee  @relation("CaixaAbertoPor", fields: [funcionarioAberturaId], references: [id])
  funcionarioFechamentoId String?
  funcionarioFechamento   Employee? @relation("CaixaFechadoPor", fields: [funcionarioFechamentoId], references: [id])

  vendas        Sale[]
  movimentacoes CaixaMovimentacao[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Cash register transactions (in/out)
model CaixaMovimentacao {
  id     String                @id @default(uuid())
  valor  Decimal
  tipo   CaixaMovimentacaoTipo
  motivo String // Example: "Supplier payment", "Cash reinforcement"

  caixaId       String
  caixa         Caixa    @relation(fields: [caixaId], references: [id], onDelete: Cascade)
  funcionarioId String
  funcionario   Employee @relation(fields: [funcionarioId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
